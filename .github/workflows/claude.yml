name: Claude Code Assistant - WE ASKED 100 PEOPLE

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, synchronize]
  pull_request_review:
    types: [submitted]

jobs:
  claude-assistant:
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¾ãŸã¯æ–°ã—ã„PRã®å ´åˆã«å®Ÿè¡Œ
    if: |
      contains(github.event.comment.body, '@claude') || 
      contains(github.event.review.body, '@claude') || 
      contains(github.event.issue.body, '@claude') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          custom-instructions: |
            ã€Œ100äººã«èãã¾ã—ãŸã€å½¢å¼ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿åé›†ã‚¢ãƒ—ãƒªã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã¾ã™ã€‚
            
            **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦:**
            - è³ªå•ä½œæˆãƒ»å›ç­”åé›†ãƒ»è‡ªå‹•é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ 
            - Rails 8æ¨™æº–èªè¨¼ + Cookie/UUIDè­˜åˆ¥
            - é¡ä¼¼å›ç­”ã®è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½
            
            **ãƒ¬ãƒ“ãƒ¥ãƒ¼é‡ç‚¹é …ç›®:**
            1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€CSRFã€èªè¨¼ãƒ»èªå¯
            2. **Rails 8æº–æ‹ **: æ–°æ©Ÿèƒ½ï¼ˆSolid Queue/Cacheï¼‰ã®é©åˆ‡ãªä½¿ç”¨
            3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: N+1å•é¡Œã€ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
            4. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: æ­£è¦åŒ–å‡¦ç†ã€é‡è¤‡é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯
            5. **UI/UX**: Bootstrap 5 + Stimuluså®Ÿè£…
            6. **æ—¥æœ¬èªåŒ–**: i18nå¯¾å¿œã€æ–‡å­—åˆ—å‡¦ç†ï¼ˆå…¨è§’/åŠè§’ç­‰ï¼‰
            
            **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯:**
            - Ruby 3.3.6 + Rails 8.0.0
            - PostgreSQL 15
            - Bootstrap 5.3 + Stimulus
            - Solid Queue/Cache
            - Dockerç’°å¢ƒ
            
            å•é¡Œç™ºè¦‹æ™‚ã¯å…·ä½“çš„ãªæ”¹å–„æ¡ˆã¨ç†ç”±ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

  claude-security-review:
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚ç”¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆPRé–‹è¨­æ™‚ã®ã¿ï¼‰
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Claude Security Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          custom-instructions: |
            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚é–€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã¨ã—ã¦PRã‚’å¯©æŸ»ã—ã¾ã™ã€‚
            
            **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
            1. **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã€Strong Parameters
            2. **CSRFæ”»æ’ƒ**: authenticity_tokenã€SameSite Cookie
            3. **èªè¨¼ãƒã‚¤ãƒ‘ã‚¹**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€Cookieæ¤œè¨¼
            4. **XSSæ”»æ’ƒ**: ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã€CSPè¨­å®š
            5. **æ©Ÿå¯†æƒ…å ±æ¼æ´©**: ãƒ­ã‚°å‡ºåŠ›ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            6. **èªå¯åˆ¶å¾¡**: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€æ¨©é™ãƒã‚§ãƒƒã‚¯
            7. **å…¥åŠ›æ¤œè¨¼**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€æ–‡å­—æ•°åˆ¶é™
            8. **ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®š**: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†ç”Ÿæˆ
            
            **é‡è¦åº¦ãƒ©ãƒ³ã‚¯ä»˜ã‘:**
            - ğŸ”´ Critical: å³åº§ã«ä¿®æ­£ãŒå¿…è¦
            - ğŸŸ¡ Warning: æ¨å¥¨æ”¹å–„é …ç›®
            - ğŸŸ¢ Info: å‚è€ƒæƒ…å ±
            
            ç™ºè¦‹ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª²é¡Œã«ã¯é‡è¦åº¦ã¨ä¿®æ­£æ–¹æ³•ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
